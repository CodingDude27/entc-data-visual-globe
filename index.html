<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Pathways Globe</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #0f172a; 
      font-family: sans-serif; 
      overflow: hidden;
    }
    #globeViz { width: 100vw; height: 100vh; }
  </style>
  <script src="https://unpkg.com/three@0.146.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.26.6/dist/globe.gl.min.js"></script>
</head>
<body>
  <div id="globeViz"></div>

  <script>
    // 1. Get data from URL query parameters (passed from Retool)
    const params = new URLSearchParams(window.location.search);
    const routesJSON = params.get('routes');
    const pointsJSON = params.get('points');
    const summaryJSON = params.get('summary');
    const selectedCountry = params.get('country');

    // Parse JSON data
    const routes = routesJSON ? JSON.parse(decodeURIComponent(routesJSON)) : [];
    const points = pointsJSON ? JSON.parse(decodeURIComponent(pointsJSON)) : [];
    const summary = summaryJSON ? JSON.parse(decodeURIComponent(summaryJSON)) : [];

    // 2. Initialize Globe
    const elem = document.getElementById('globeViz');
    const world = Globe()
      (elem)
      .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .backgroundColor('#0f172a');

    // 3. Render Arcs (Migration Routes) - GLOWING EFFECT
    if (routes && routes.length) {
      world
        .arcsData(routes)
        .arcStartLat(d => d.origin_lat)
        .arcStartLng(d => d.origin_lng)
        .arcEndLat(d => d.dest_lat)
        .arcEndLng(d => d.dest_lng)
        .arcColor(d => {
          // Glowing color effect based on flow intensity
          const intensity = d.flow_count / 100; // normalize
          return intensity > 0.5 ? '#ec4899' : '#3b82f6'; // Pink (glow) or Blue
        })
        .arcDashLength(0.4)
        .arcDashGap(0.2)
        .arcDashAnimateTime(1500)
        .arcStroke(0.6)
        .arcOpacity(0.8)
        .arcCurveResolution(64);
    }

    // 4. Render Points (Universities) - GREEN DOTS
    if (points && points.length) {
      world
        .pointsData(points)
        .pointLat('latitude')
        .pointLng('longitude')
        .pointColor(() => '#10b981') // Emerald Green
        .pointRadius(d => Math.min(d.incoming_students / 100, 0.5)) // Size based on student count
        .pointAltitude(0.02)
        .pointLabel(d => `<b>${d.university_name}</b><br/>Students: ${d.incoming_students}`);
    }

    // 5. Auto-Zoom to Selected Country
    if (selectedCountry && summary && summary.length > 0) {
      const target = summary.find(c => c.country_name === selectedCountry);
      
      if (target) {
        // Smooth camera pan to country
        world.pointOfView({
          lat: parseFloat(target.latitude),
          lng: parseFloat(target.longitude),
          altitude: 1.5
        }, 1500); // 1.5s animation
      }
    } else {
      // Default: Auto-rotate
      world.controls().autoRotate = true;
      world.controls().autoRotateSpeed = 0.5;
    }

    // 6. Handle window resize
    window.addEventListener('resize', () => {
      world.width(window.innerWidth).height(window.innerHeight);
    });
  </script>
</body>
</html>
