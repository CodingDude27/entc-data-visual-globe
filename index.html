<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Immigration Globe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a1628 0%, #1a2744 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #ffffff;
        }

        #globeViz {
            width: 100vw;
            height: 100vh;
        }

        /* Minimal pause/play button - top left only */
        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        #toggle-rotation {
            border: 1px solid rgba(59, 130, 246, 0.6);
            background: rgba(15, 23, 42, 0.85);
            color: #e5e7eb;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            backdrop-filter: blur(12px);
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        #toggle-rotation:hover {
            background: rgba(30, 64, 175, 0.95);
            color: #ffffff;
            border-color: rgba(59, 130, 246, 1);
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 200;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #3b82f6;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Loading Globe...</div>
    </div>

    <!-- Minimal controls: pause/play only -->
    <div id="controls">
        <button id="toggle-rotation">‚è∏ Pause</button>
    </div>

    <div id="globeViz"></div>

    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        // ============================================
        // CONFIGURATION & COLOR THEME
        // ============================================
        const COLORS = {
            lineHigh: '#ef4444',      // Red: 500+ students
            lineMedium: '#3b82f6',    // Blue: 100-500 students
            lineLow: '#10b981',       // Green: <100 students
            glowHigh: 'rgba(239, 68, 68, 0.9)',
            glowMedium: 'rgba(59, 130, 246, 0.9)',
            glowLow: 'rgba(16, 185, 129, 0.9)'
        };

        const countryCoords = {
            'Australia': { lat: -25.2744, lng: 133.7751 },
            'Canada': { lat: 56.1304, lng: -106.3468 },
            'Finland': { lat: 61.9241, lng: 25.7482 },
            'Germany': { lat: 51.1657, lng: 10.4515 },
            'India': { lat: 20.5937, lng: 78.9629 },
            'Ireland': { lat: 53.4129, lng: -8.2439 },
            'Russia': { lat: 61.5240, lng: 105.3188 },
            'South Africa': { lat: -30.5595, lng: 22.9375 },
            'UAE': { lat: 23.4241, lng: 53.8478 },
            'UK': { lat: 55.3781, lng: -3.4360 },
            'USA': { lat: 37.0902, lng: -95.7129 }
        };

        // ============================================
        // GLOBAL STATE
        // ============================================
        let globeInstance = null;
        let allMigrationData = [];
        let filteredData = [];
        let selectedCountry = null;
        let autoRotate = true;

        // ============================================
        // HELPERS
        // ============================================
        function getLineColor(count) {
            if (count >= 500) return COLORS.lineHigh;
            if (count >= 100) return COLORS.lineMedium;
            return COLORS.lineLow;
        }

        function getLineGlow(count) {
            if (count >= 500) return COLORS.glowHigh;
            if (count >= 100) return COLORS.glowMedium;
            return COLORS.glowLow;
        }

        function getLineWidth(count) {
            return Math.min(3.0, Math.max(0.8, count / 250));
        }

        function getArcAltitude(count) {
            return Math.min(0.4, Math.max(0.15, count / 2000));
        }

        // ============================================
        // INITIALIZE GLOBE
        // ============================================
        function initGlobe() {
            globeInstance = Globe()(document.getElementById('globeViz'))
                .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-dark.jpg')
                .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
                .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
                .width(window.innerWidth)
                .height(window.innerHeight)
                .atmosphereColor('rgba(100, 150, 255, 0.3)')
                .atmosphereAltitude(0.15);

            // Configure controls
            globeInstance.controls().enableDamping = true;
            globeInstance.controls().dampingFactor = 0.05;
            globeInstance.controls().rotateSpeed = 0.5;
            globeInstance.controls().autoRotate = true;
            globeInstance.controls().autoRotateSpeed = 0.4;

            // Initial view
            globeInstance.pointOfView({ lat: 20, lng: 20, altitude: 2.2 }, 0);

            console.log('‚úÖ Globe initialized - ready for Retool data');
        }

        // ============================================
        // UPDATE GLOBE WITH DATA
        // ============================================
        function updateGlobe(data, filterCountry = null) {
            if (!data || !data.migrations) return;

            allMigrationData = data.migrations;

            // Filter if needed
            if (filterCountry) {
                filteredData = allMigrationData.filter(flow =>
                    flow.origin === filterCountry || flow.destination === filterCountry
                );
            } else {
                filteredData = allMigrationData;
            }

            // Create arc data
            const arcsData = filteredData.map(flow => {
                const startCoord = countryCoords[flow.origin];
                const endCoord = countryCoords[flow.destination];

                if (!startCoord || !endCoord) return null;

                return {
                    startLat: startCoord.lat,
                    startLng: startCoord.lng,
                    endLat: endCoord.lat,
                    endLng: endCoord.lng,
                    count: flow.count,
                    origin: flow.origin,
                    destination: flow.destination
                };
            }).filter(arc => arc !== null);

            // Create points for countries
            const activeCountries = new Set();
            filteredData.forEach(flow => {
                if (countryCoords[flow.origin]) activeCountries.add(flow.origin);
                if (countryCoords[flow.destination]) activeCountries.add(flow.destination);
            });

            const pointsData = Array.from(activeCountries).map(country => ({
                lat: countryCoords[country].lat,
                lng: countryCoords[country].lng,
                country: country,
                size: selectedCountry === country ? 0.5 : 0.3
            }));

            // Update globe
            globeInstance
                .arcsData(arcsData)
                .arcColor(d => getLineColor(d.count))
                .arcStroke(d => getLineWidth(d.count))
                .arcAltitude(d => getArcAltitude(d.count))
                .arcDashLength(0.8)
                .arcDashGap(0.05)
                .arcDashAnimateTime(3000)
                .arcLabel(d => `
                    <div style="background: rgba(10, 22, 40, 0.95); padding: 12px 16px; border-radius: 8px; border: 1px solid ${getLineColor(d.count)}; font-family: Inter, sans-serif;">
                        <div style="color: ${getLineColor(d.count)}; font-size: 14px; font-weight: 600; margin-bottom: 4px;">${d.origin} ‚Üí ${d.destination}</div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 13px;">${d.count} students</div>
                    </div>
                `)
                .pointsData(pointsData)
                .pointAltitude(0.01)
                .pointRadius(d => d.size)
                .pointColor(d => selectedCountry === d.country ? '#fbbf24' : '#60a5fa')
                .pointLabel(d => `
                    <div style="background: rgba(10, 22, 40, 0.95); padding: 10px 14px; border-radius: 8px; border: 1px solid #3b82f6;">
                        <strong style="color: #60a5fa; font-size: 13px;">${d.country}</strong>
                    </div>
                `);

            // Camera tracking for filtered country
            if (filterCountry && countryCoords[filterCountry]) {
                globeInstance.pointOfView(
                    {
                        lat: countryCoords[filterCountry].lat,
                        lng: countryCoords[filterCountry].lng,
                        altitude: 1.8
                    },
                    1200
                );
            }

            console.log(`‚úÖ Globe updated: ${arcsData.length} routes visible`);
        }

        // ============================================
        // PAUSE/PLAY CONTROL
        // ============================================
        const toggleBtn = document.getElementById('toggle-rotation');
        toggleBtn.addEventListener('click', () => {
            autoRotate = !autoRotate;
            globeInstance.controls().autoRotate = autoRotate;
            toggleBtn.textContent = autoRotate ? '‚è∏ Pause' : '‚ñ∂ Play';
        });

        // ============================================
        // RETOOL API (Main Interface)
        // ============================================
        window.globeAPI = {
            // Load initial data from Retool
            loadData: function(data) {
                if (data && data.migrations) {
                    updateGlobe(data);
                    console.log('‚úÖ Data loaded:', data.migrations.length, 'routes');
                }
            },

            // Filter by country - shows only flows in/out
            filterCountry: function(country) {
                selectedCountry = country;
                updateGlobe({ migrations: allMigrationData }, country);
                console.log('‚úÖ Filtered to:', country);
            },

            // Clear all filters - show everything
            clearFilters: function() {
                selectedCountry = null;
                updateGlobe({ migrations: allMigrationData });
                console.log('‚úÖ All routes visible');
            },

            // Highlight specific route and zoom to it
            selectRoute: function(origin, destination) {
                const route = allMigrationData.find(d =>
                    d.origin === origin && d.destination === destination
                );

                if (route && countryCoords[origin] && countryCoords[destination]) {
                    const startCoord = countryCoords[origin];
                    const endCoord = countryCoords[destination];
                    const midLat = (startCoord.lat + endCoord.lat) / 2;
                    const midLng = (startCoord.lng + endCoord.lng) / 2;

                    // Show only this route
                    filteredData = [route];
                    allMigrationData = [route]; // Temporarily for display

                    // Update display
                    updateGlobe({ migrations: [route] }, null);

                    // Track camera to route
                    globeInstance.pointOfView(
                        { lat: midLat, lng: midLng, altitude: 1.5 },
                        1000
                    );

                    console.log('‚úÖ Route selected:', origin, '‚Üí', destination);
                }
            },

            // Reset camera to default
            resetCamera: function() {
                globeInstance.pointOfView({ lat: 20, lng: 20, altitude: 2.2 }, 1000);
            },

            // Get current state (for debugging)
            getState: function() {
                return {
                    selectedCountry,
                    visibleRoutes: filteredData.length,
                    totalRoutes: allMigrationData.length,
                    autoRotate
                };
            }
        };

        // ============================================
        // POSTMESSAGE API (Alternative for Retool)
        // ============================================
        window.addEventListener('message', (event) => {
            const { type, data, country, route } = event.data || {};

            if (type === 'INIT_DATA') window.globeAPI.loadData(data);
            if (type === 'FILTER_COUNTRY') window.globeAPI.filterCountry(country);
            if (type === 'SELECT_ROUTE' && route) 
                window.globeAPI.selectRoute(route.origin, route.destination);
            if (type === 'CLEAR_FILTER') window.globeAPI.clearFilters();
        });

        // ============================================
        // WINDOW RESIZE
        // ============================================
        window.addEventListener('resize', () => {
            if (globeInstance) {
                globeInstance
                    .width(window.innerWidth)
                    .height(window.innerHeight);
            }
        });

        // ============================================
        // STARTUP
        // ============================================
        initGlobe();

        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
        }, 1500);

        console.log('üåç Globe ready for Retool');
        console.log('üì° API available: window.globeAPI');
        console.log('   - globeAPI.loadData({migrations: [...]})');
        console.log('   - globeAPI.filterCountry("India")');
        console.log('   - globeAPI.selectRoute("India", "USA")');
        console.log('   - globeAPI.clearFilters()');
    </script>
</body>
</html>
