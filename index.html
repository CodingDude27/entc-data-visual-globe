<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Pathways Globe - Animated Flows</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #0f172a; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      color: #fff;
    }
    #globeViz { 
      width: 100vw; 
      height: 100vh; 
      display: block;
    }
    #tooltip {
      position: absolute;
      background: rgba(15, 23, 42, 0.95);
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #3b82f6;
      font-size: 13px;
      color: #e0e7ff;
      pointer-events: none;
      z-index: 999;
      display: none;
      max-width: 250px;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
    }
  </style>
</head>
<body>
  <div id="globeViz"></div>
  <div id="tooltip"></div>

  <script src="https://unpkg.com/three@0.146.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.26.6/dist/globe.gl.min.js"></script>

  <script>
    // ==================== MIGRATION FLOWS ====================
    const migrationFlows = [
      { origin_country: "Germany", origin_lat: 51.1657, origin_lng: 10.4515, destination_country: "UAE", dest_lat: 23.4241, dest_lng: 53.8478, flow_count: 72 },
      { origin_country: "India", origin_lat: 20.5937, origin_lng: 78.9629, destination_country: "UK", dest_lat: 55.3781, dest_lng: -3.436, flow_count: 72 },
      { origin_country: "Russia", origin_lat: 61.52, origin_lng: 105.32, destination_country: "UAE", dest_lat: 23.4241, dest_lng: 53.8478, flow_count: 71 },
      { origin_country: "USA", origin_lat: 37.0902, origin_lng: -95.7129, destination_country: "Ireland", dest_lat: 53.4129, dest_lng: -8.2439, flow_count: 69 },
      { origin_country: "Canada", origin_lat: 56.1304, origin_lng: -106.3468, destination_country: "Russia", dest_lat: 61.52, dest_lng: 105.32, flow_count: 68 },
      { origin_country: "Canada", origin_lat: 56.1304, origin_lng: -106.3468, destination_country: "Germany", dest_lat: 51.1657, dest_lng: 10.4515, flow_count: 67 },
      { origin_country: "Russia", origin_lat: 61.52, origin_lng: 105.32, destination_country: "Germany", dest_lat: 51.1657, dest_lng: 10.4515, flow_count: 67 },
      { origin_country: "Germany", origin_lat: 51.1657, origin_lng: 10.4515, destination_country: "Russia", dest_lat: 61.52, dest_lng: 105.32, flow_count: 67 },
      { origin_country: "UK", origin_lat: 55.3781, origin_lng: -3.436, destination_country: "UAE", dest_lat: 23.4241, dest_lng: 53.8478, flow_count: 66 },
      { origin_country: "Russia", origin_lat: 61.52, origin_lng: 105.32, destination_country: "Ireland", dest_lat: 53.4129, dest_lng: -8.2439, flow_count: 66 },
      { origin_country: "Ireland", origin_lat: 53.4129, origin_lng: -8.2439, destination_country: "India", dest_lat: 20.5937, dest_lng: 78.9629, flow_count: 65 },
      { origin_country: "Russia", origin_lat: 61.52, origin_lng: 105.32, destination_country: "UK", dest_lat: 55.3781, dest_lng: -3.436, flow_count: 65 },
      { origin_country: "Germany", origin_lat: 51.1657, origin_lng: 10.4515, destination_country: "India", dest_lat: 20.5937, dest_lng: 78.9629, flow_count: 63 },
      { origin_country: "UK", origin_lat: 55.3781, origin_lng: -3.436, destination_country: "Germany", dest_lat: 51.1657, dest_lng: 10.4515, flow_count: 63 },
      { origin_country: "USA", origin_lat: 37.0902, origin_lng: -95.7129, destination_country: "Canada", dest_lat: 56.1304, dest_lng: -106.3468, flow_count: 63 },
      { origin_country: "Ireland", origin_lat: 53.4129, origin_lng: -8.2439, destination_country: "South Africa", dest_lat: -30.5595, dest_lng: 22.9375, flow_count: 63 },
      { origin_country: "Ireland", origin_lat: 53.4129, origin_lng: -8.2439, destination_country: "USA", dest_lat: 37.0902, dest_lng: -95.7129, flow_count: 63 },
      { origin_country: "Ireland", origin_lat: 53.4129, origin_lng: -8.2439, destination_country: "UK", dest_lat: 55.3781, dest_lng: -3.436, flow_count: 63 },
      { origin_country: "South Africa", origin_lat: -30.5595, origin_lng: 22.9375, destination_country: "UK", dest_lat: 55.3781, dest_lng: -3.436, flow_count: 63 },
      { origin_country: "South Africa", origin_lat: -30.5595, origin_lng: 22.9375, destination_country: "Ireland", dest_lat: 53.4129, dest_lng: -8.2439, flow_count: 62 },
      { origin_country: "Russia", origin_lat: 61.52, origin_lng: 105.32, destination_country: "Finland", dest_lat: 61.9241, dest_lng: 25.7482, flow_count: 61 },
      { origin_country: "Finland", origin_lat: 61.9241, origin_lng: 25.7482, destination_country: "UK", dest_lat: 55.3781, dest_lng: -3.436, flow_count: 61 },
      { origin_country: "Germany", origin_lat: 51.1657, origin_lng: 10.4515, destination_country: "Finland", dest_lat: 61.9241, dest_lng: 25.7482, flow_count: 61 },
      { origin_country: "USA", origin_lat: 37.0902, origin_lng: -95.7129, destination_country: "Germany", dest_lat: 51.1657, dest_lng: 10.4515, flow_count: 61 },
      { origin_country: "Germany", origin_lat: 51.1657, origin_lng: 10.4515, destination_country: "USA", dest_lat: 37.0902, dest_lng: -95.7129, flow_count: 61 },
      { origin_country: "UAE", origin_lat: 23.4241, origin_lng: 53.8478, destination_country: "Finland", dest_lat: 61.9241, dest_lng: 25.7482, flow_count: 60 },
      { origin_country: "Finland", origin_lat: 61.9241, origin_lng: 25.7482, destination_country: "Germany", dest_lat: 51.1657, dest_lng: 10.4515, flow_count: 60 },
      { origin_country: "South Africa", origin_lat: -30.5595, origin_lng: 22.9375, destination_country: "India", dest_lat: 20.5937, dest_lng: 78.9629, flow_count: 60 },
      { origin_country: "UK", origin_lat: 55.3781, origin_lng: -3.436, destination_country: "India", dest_lat: 20.5937, dest_lng: 78.9629, flow_count: 59 },
      { origin_country: "USA", origin_lat: 37.0902, origin_lng: -95.7129, destination_country: "UAE", dest_lat: 23.4241, dest_lng: 53.8478, flow_count: 59 }
    ];

    // UNIVERSITIES
    const universities = [
      { university_name: "University of Stuttgart", city: "Stuttgart", country: "Germany", latitude: 48.7758, longitude: 9.1829, incoming_students: 90 },
      { university_name: "Zayed University", city: "Abu Dhabi", country: "UAE", latitude: 24.1565, longitude: 54.4056, incoming_students: 89 },
      { university_name: "Moscow Institute of Physics and Technology", city: "Moscow", country: "Russia", latitude: 55.6761, longitude: 37.2764, incoming_students: 87 },
      { university_name: "Manipal Academy Dubai", city: "Dubai", country: "UAE", latitude: 25.1972, longitude: 55.2744, incoming_students: 81 },
      { university_name: "Heriot-Watt Dubai", city: "Dubai", country: "UAE", latitude: 25.1876, longitude: 55.2719, incoming_students: 80 },
      { university_name: "Bauman Moscow State Technical University", city: "Moscow", country: "Russia", latitude: 55.7640, longitude: 37.5857, incoming_students: 80 },
      { university_name: "Rhodes University", city: "Grahamstown", country: "South Africa", latitude: -33.3038, longitude: 26.5225, incoming_students: 79 },
      { university_name: "Heidelberg University", city: "Heidelberg", country: "Germany", latitude: 49.4158, longitude: 8.6714, incoming_students: 78 },
      { university_name: "UCLA", city: "Los Angeles", country: "USA", latitude: 34.0695, longitude: -118.4432, incoming_students: 77 },
      { university_name: "Åbo Akademi University", city: "Turku", country: "Finland", latitude: 60.4518, longitude: 22.2666, incoming_students: 76 },
      { university_name: "Novosibirsk State University", city: "Novosibirsk", country: "Russia", latitude: 54.8464, longitude: 83.0954, incoming_students: 76 },
      { university_name: "Khalifa University", city: "Abu Dhabi", country: "UAE", latitude: 24.1565, longitude: 54.4056, incoming_students: 75 },
      { university_name: "University of Johannesburg", city: "Johannesburg", country: "South Africa", latitude: -26.1907, longitude: 28.0365, incoming_students: 75 },
      { university_name: "Humboldt University", city: "Berlin", country: "Germany", latitude: 52.5200, longitude: 13.3949, incoming_students: 75 },
      { university_name: "National University of Ireland Galway", city: "Galway", country: "Ireland", latitude: 53.2707, longitude: -9.0489, incoming_students: 74 },
      { university_name: "University of Dubai", city: "Dubai", country: "UAE", latitude: 25.1972, longitude: 55.2744, incoming_students: 74 },
      { university_name: "Saint Petersburg State University", city: "Saint Petersburg", country: "Russia", latitude: 59.9342, longitude: 30.3351, incoming_students: 74 },
      { university_name: "University of KwaZulu-Natal", city: "Durban", country: "South Africa", latitude: -29.8683, longitude: 30.9789, incoming_students: 73 },
      { university_name: "University of Oxford", city: "Oxford", country: "UK", latitude: 51.7558, longitude: -1.2543, incoming_students: 73 },
      { university_name: "Technical University of Munich", city: "Munich", country: "Germany", latitude: 48.2646, longitude: 11.6681, incoming_students: 73 },
      { university_name: "University of Cambridge", city: "Cambridge", country: "UK", latitude: 52.1951, longitude: 0.1313, incoming_students: 72 },
      { university_name: "RWTH Aachen", city: "Aachen", country: "Germany", latitude: 50.7753, longitude: 6.0622, incoming_students: 72 },
      { university_name: "Lomonosov Moscow State University", city: "Moscow", country: "Russia", latitude: 55.7386, longitude: 37.6068, incoming_students: 72 },
      { university_name: "IIT Bombay", city: "Mumbai", country: "India", latitude: 19.1136, longitude: 72.9114, incoming_students: 71 },
      { university_name: "University of British Columbia", city: "Vancouver", country: "Canada", latitude: 49.2827, longitude: -123.2549, incoming_students: 71 },
      { university_name: "Harvard University", city: "Boston", country: "USA", latitude: 42.3601, longitude: -71.1138, incoming_students: 70 },
      { university_name: "University of Birmingham", city: "Birmingham", country: "UK", latitude: 52.4515, longitude: -1.9369, incoming_students: 70 },
      { university_name: "Universität Kaiserslautern", city: "Kaiserslautern", country: "Germany", latitude: 49.4357, longitude: 7.7697, incoming_students: 70 },
      { university_name: "Trinity College Dublin", city: "Dublin", country: "Ireland", latitude: 53.3439, longitude: -6.2546, incoming_students: 69 },
      { university_name: "University of Cape Town", city: "Cape Town", country: "South Africa", latitude: -33.9249, longitude: 18.4241, incoming_students: 69 },
      { university_name: "University of Helsinki", city: "Helsinki", country: "Finland", latitude: 60.1695, longitude: 24.9354, incoming_students: 68 },
      { university_name: "University of Toronto", city: "Toronto", country: "Canada", latitude: 43.6629, longitude: -79.3957, incoming_students: 68 },
      { university_name: "University of Delhi", city: "Delhi", country: "India", latitude: 28.5244, longitude: 77.1855, incoming_students: 67 },
      { university_name: "Stanford University", city: "Stanford", country: "USA", latitude: 37.4275, longitude: -122.1697, incoming_students: 67 },
      { university_name: "University of Manchester", city: "Manchester", country: "UK", latitude: 53.4668, longitude: -2.2339, incoming_students: 67 }
    ];

    // ==================== GLOBE SETUP ====================
    const elem = document.getElementById('globeViz');
    const tooltip = document.getElementById('tooltip');
    const world = Globe()
      (elem)
      .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
      .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
      .backgroundColor('#0f172a')
      .width(window.innerWidth)
      .height(window.innerHeight);

    // ==================== RENDER SEMI-TRANSPARENT LINES ====================
    world
      .arcsData(migrationFlows)
      .arcStartLat(d => d.origin_lat)
      .arcStartLng(d => d.origin_lng)
      .arcEndLat(d => d.dest_lat)
      .arcEndLng(d => d.dest_lng)
      .arcColor(() => '#3b82f6') // Blue
      .arcAltitude(0.25) // Higher arcs for nicer 3D shape
      .arcDashLength(1)
      .arcDashGap(0)
      .arcStroke(1.2)
      .arcOpacity(0.28) // More transparent so glow stands out
      .arcCurveResolution(128)
      .arcLabel(d => `${d.origin_country} → ${d.destination_country}<br/>Students: ${d.flow_count}`)
      .onArcHover(hoverD => {
        if (hoverD) {
          world.arcsData(migrationFlows.map(d => ({
            ...d,
            isHovered: d === hoverD
          })))
          .arcOpacity(d => d.isHovered ? 0.9 : 0.08)
          .arcStroke(d => d.isHovered ? 2.2 : 1.0);

          tooltip.innerHTML = `
            <div><strong>${hoverD.origin_country}</strong> → <strong>${hoverD.destination_country}</strong></div>
            <div style="margin-top: 6px; color: #10b981;">
              <strong>${hoverD.flow_count}</strong> students
            </div>
          `;
          tooltip.style.display = 'block';
          elem.style.cursor = 'pointer';
        } else {
          world.arcsData(migrationFlows)
          .arcOpacity(0.28)
          .arcStroke(1.2);

          tooltip.style.display = 'none';
          elem.style.cursor = 'auto';
        }
      });

    // Move tooltip
    document.addEventListener('mousemove', (e) => {
      if (tooltip.style.display === 'block') {
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY - 10) + 'px';
      }
    });

    // ==================== RENDER UNIVERSITIES ====================
    world
      .pointsData(universities)
      .pointLat('latitude')
      .pointLng('longitude')
      .pointColor(() => '#10b981')
      .pointRadius(d => {
        const maxStudents = Math.max(...universities.map(u => u.incoming_students));
        return (d.incoming_students / maxStudents) * 0.5 + 0.15;
      })
      .pointAltitude(0.05)
      .pointLabel(d => `<b>${d.university_name}</b><br/>${d.city}, ${d.country}<br/>Incoming: ${d.incoming_students} students`)
      .onPointHover(hoverD => {
        elem.style.cursor = hoverD ? 'pointer' : 'auto';
      });

    // ==================== GLOWING PARTICLES ON LINES ====================
    const scene = world.scene();
    const THREE_GLOBALS = window.THREE;
    
    // Helper: Convert lat/lng to 3D position
    function latLngToXYZ(lat, lng) {
      const latRad = lat * Math.PI / 180;
      const lngRad = lng * Math.PI / 180;
      return {
        x: Math.cos(latRad) * Math.cos(lngRad),
        y: Math.cos(latRad) * Math.sin(lngRad),
        z: Math.sin(latRad)
      };
    }

    // Helper: Spherical interpolation
    function slerp(p0, p1, t) {
      const cosAngle = p0.x * p1.x + p0.y * p1.y + p0.z * p1.z;
      const angle = Math.acos(Math.min(Math.max(cosAngle, -1), 1));
      const sinAngle = Math.sin(angle);
      
      if (sinAngle < 0.001) return p0;
      
      const a = Math.sin((1 - t) * angle) / sinAngle;
      const b = Math.sin(t * angle) / sinAngle;
      
      return {
        x: a * p0.x + b * p1.x,
        y: a * p0.y + b * p1.y,
        z: a * p0.z + b * p1.z
      };
    }

    // Create particle points (3 per route)
    const particlePositions = [];
    const particleColors = [];

    for (let i = 0; i < migrationFlows.length * 3; i++) {
      particlePositions.push(0, 0, 0);
      // very bright bluish-white so it pops against dark earth
      particleColors.push(0.85, 0.93, 1.0);
    }

    const geometry = new THREE_GLOBALS.BufferGeometry();
    geometry.setAttribute('position', new THREE_GLOBALS.BufferAttribute(new Float32Array(particlePositions), 3));
    geometry.setAttribute('color', new THREE_GLOBALS.BufferAttribute(new Float32Array(particleColors), 3));

    const material = new THREE_GLOBALS.PointsMaterial({
      size: 0.6,                 // much larger, clearly visible
      sizeAttenuation: true,
      vertexColors: true,
      transparent: true,
      opacity: 0.95,
      blending: THREE_GLOBALS.AdditiveBlending, // strong glow
      depthWrite: false
    });

    const particles = new THREE_GLOBALS.Points(geometry, material);
    scene.add(particles);

    const posAttr = geometry.getAttribute('position');
    const startTime = Date.now();

    // Animation: slow flow (~10 seconds per full trip)
    world.renderer().render = (function() {
      const originalRender = world.renderer().render.bind(world.renderer());
      return function(scene, camera) {
        const elapsed = (Date.now() - startTime) / 1000;
        const posArray = posAttr.array;

        for (let i = 0; i < migrationFlows.length; i++) {
          const flow = migrationFlows[i];
          const p0 = latLngToXYZ(flow.origin_lat, flow.origin_lng);
          const p1 = latLngToXYZ(flow.dest_lat, flow.dest_lng);

          for (let j = 0; j < 3; j++) {
            const idx = i * 3 + j;
            const offset = (j / 3) * 0.7;         // staggered along the line
            const progress = (elapsed * 0.10 + offset) % 1.0; // SLOW: ~10s per cycle
            const pos = slerp(p0, p1, progress);

            // lift slightly above globe surface so it rides along the arc
            const lift = 1.05 + 0.05 * Math.sin(progress * Math.PI);
            posArray[idx * 3]     = pos.x * lift;
            posArray[idx * 3 + 1] = pos.y * lift;
            posArray[idx * 3 + 2] = pos.z * lift;
          }
        }
        posAttr.needsUpdate = true;
        return originalRender(scene, camera);
      };
    })();

    // ==================== CONTROLS (SLOW SPIN) ====================
    world.controls().enableZoom = true;
    world.controls().enablePan = true;
    world.controls().enableRotate = true;
    world.controls().autoRotate = true;
    world.controls().autoRotateSpeed = 0.08; // slower spin

    window.addEventListener('resize', () => {
      world.width(window.innerWidth).height(window.innerHeight);
    });

    setTimeout(() => {
      world.pointOfView({ lat: 25, lng: 0, altitude: 3.0 });
    }, 500);
  </script>
</body>
</html>
