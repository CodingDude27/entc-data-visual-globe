<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Immigration Flows - Glowing Globe</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: #020617; color: #f8fafc; overflow: hidden; height: 100vh; width: 100vw; position: relative; }
        #globeViz { width: 100vw; height: 100vh; display: block; }
        #tooltip {
            position: absolute;
            background: rgba(0, 19, 51, 0.95); /* Slightly more opaque */
            border: 1px solid rgba(59, 130, 246, 0.6);
            box-shadow: 0 0 25px rgba(37, 99, 235, 0.45);
            border-radius: 12px;
            padding: 14px 18px;
            font-size: 13px;
            color: #e0f2fe;
            pointer-events: none;
            z-index: 10;
            display: none;
            min-width: 220px;
            backdrop-filter: blur(12px);
            transition: opacity 0.15s ease;
        }
        #tooltip h3 { font-size: 15px; font-weight: 700; margin-bottom: 8px; color: #93c5fd; border-bottom: 1px solid rgba(59, 130, 246, 0.3); padding-bottom: 4px; }
        #tooltip .stat { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 12px; color: #cbd5f5; }
        #tooltip .stat span:last-child { font-weight: 600; color: #fefce8; }
        
        #playPauseBtn {
            position: absolute; bottom: 30px; right: 30px; width: 50px; height: 50px;
            border-radius: 50%; background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(59, 130, 246, 0.6);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 20; opacity: 0;
            transform: translateY(10px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        #playPauseBtn.visible { opacity: 1; transform: translateY(0) scale(1); }
        #playPauseBtn:hover { transform: scale(1.1); box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); border-color: #93c5fd; }
        #playPauseBtn svg { width: 20px; height: 20px; fill: #60a5fa; transition: fill 0.2s; }
        #playPauseBtn:hover svg { fill: #ffffff; }

        .pulse-marker { width: 32px; height: 32px; position: absolute; transform: translate(-50%, -50%); pointer-events: auto; }
        .pulse-core, .pulse-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 999px; }
        .pulse-core { width: 8px; height: 8px; background: #60a5fa; box-shadow: 0 0 12px #3b82f6; }
        .pulse-ring { width: 24px; height: 24px; border: 1px solid rgba(96, 165, 250, 0.6); animation: ripple 2s ease-out infinite; }
        @keyframes ripple { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
    </style>
</head>
<body>
    <div id="globeViz"></div>
    <div id="tooltip"></div>
    <div id="playPauseBtn"><svg viewBox="0 0 24 24"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg></div>

    <script src="https://unpkg.com/three@0.146.0/build/three.min.js"></script>
    <script src="https://unpkg.com/globe.gl@2.26.6/dist/globe.gl.min.js"></script>

    <script>
        let animationPlaying = true;
        let globeHovered = false;
        let lastHoveredArc = null;

        const countries = [
            { name: "Germany", id: "C0003", lat: 50.04, lng: 10.54, outgoing: 531, incoming: 518 },
            { name: "India", id: "C0004", lat: 21.25, lng: 77.08, outgoing: 498, incoming: 493 },
            { name: "Ireland", id: "C0005", lat: 53.13, lng: -7.02, outgoing: 510, incoming: 472 },
            { name: "Russia", id: "C0006", lat: 56.24, lng: 44.69, outgoing: 532, incoming: 515 },
            { name: "South Africa", id: "C0007", lat: -29.88, lng: 25.58, outgoing: 493, incoming: 496 },
            { name: "UAE", id: "C0008", lat: 24.96, lng: 55.02, outgoing: 451, incoming: 538 },
            { name: "UK", id: "C0009", lat: 53.16, lng: -1.69, outgoing: 499, incoming: 526 },
            { name: "USA", id: "C0010", lat: 39.67, lng: -92.58, outgoing: 504, incoming: 485 }
        ];

        const migrationFlows = [];
        countries.forEach(source => {
            countries.forEach(target => {
                if (source.id !== target.id) {
                    migrationFlows.push({
                        origin_country: source.name, origin_lat: source.lat, origin_lng: source.lng,
                        destination_country: target.name, dest_lat: target.lat, dest_lng: target.lng,
                        flow_count: Math.round((source.outgoing * target.incoming) / 1000) + 18,
                        source_outgoing: source.outgoing, target_incoming: target.incoming
                    });
                }
            });
        });

        migrationFlows.sort((a, b) => b.flow_count - a.flow_count);
        const topFlows = migrationFlows.slice(0, 30); // Top 30 flows
        const maxFlow = Math.max(...topFlows.map(f => f.flow_count));

        const elem = document.getElementById('globeViz');
        const tooltip = document.getElementById('tooltip');
        const playPauseBtn = document.getElementById('playPauseBtn');

        const world = Globe()(elem)
            .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-dark.jpg')
            .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
            .backgroundColor('#020617')
            .showAtmosphere(true)
            .atmosphereColor('#3b82f6')
            .atmosphereAltitude(0.2)
            .width(window.innerWidth)
            .height(window.innerHeight);

        // --- ARCS CONFIGURATION ---
        world
            .arcsData(topFlows)
            .arcStartLat(d => d.origin_lat)
            .arcStartLng(d => d.origin_lng)
            .arcEndLat(d => d.dest_lat)
            .arcEndLng(d => d.dest_lng)
            .arcAltitude(d => 0.1 + (d.flow_count / maxFlow) * 0.3)
            // Default color: Transparent Blue
            .arcColor(d => [
                'rgba(59, 130, 246, 0.2)', 
                'rgba(59, 130, 246, 0.5)', 
                'rgba(59, 130, 246, 0.2)'
            ])
            // FIXED STROKE: Thicker by default, NO change on hover to prevent glitch
            .arcStroke(d => 1.0 + (d.flow_count / maxFlow) * 1.5) 
            .arcDashLength(0.9)
            .arcDashGap(0.1)
            .arcDashAnimateTime(2000)
            .onArcHover(hoverD => {
                // Debounce check
                if (hoverD === lastHoveredArc) return;
                lastHoveredArc = hoverD;

                if (hoverD) {
                    // HOVER STATE: Only change COLOR, not Geometry/Stroke
                    world.arcColor(d => {
                        const isHovered = d === hoverD;
                        // Hovered: Bright White/Blue Opaque
                        // Others: Very faint
                        return isHovered 
                            ? ['rgba(255, 255, 255, 0.9)', 'rgba(96, 165, 250, 1.0)', 'rgba(255, 255, 255, 0.9)']
                            : ['rgba(59, 130, 246, 0.05)', 'rgba(59, 130, 246, 0.1)', 'rgba(59, 130, 246, 0.05)'];
                    });

                    // Update Tooltip
                    tooltip.innerHTML = `
                        <h3>${hoverD.origin_country} âž” ${hoverD.destination_country}</h3>
                        <div class="stat"><span>Flow Volume</span><span>${hoverD.flow_count}</span></div>
                        <div class="stat"><span>${hoverD.origin_country} Out</span><span>${hoverD.source_outgoing}</span></div>
                        <div class="stat"><span>${hoverD.destination_country} In</span><span>${hoverD.target_incoming}</span></div>
                    `;
                    tooltip.style.display = 'block';
                    elem.style.cursor = 'pointer';
                    world.controls().autoRotate = false; // Pause rotation for reading
                } else {
                    // RESET STATE
                    world.arcColor(d => [
                        'rgba(59, 130, 246, 0.2)', 
                        'rgba(59, 130, 246, 0.5)', 
                        'rgba(59, 130, 246, 0.2)'
                    ]);
                    
                    tooltip.style.display = 'none';
                    elem.style.cursor = 'default';
                    if(animationPlaying) world.controls().autoRotate = true;
                }
            });

        // --- MARKERS ---
        world
            .htmlElementsData(countries)
            .htmlLat(d => d.lat)
            .htmlLng(d => d.lng)
            .htmlAltitude(0.01)
            .htmlElement(d => {
                const el = document.createElement('div');
                el.className = 'pulse-marker';
                el.innerHTML = '<span class="pulse-ring"></span><span class="pulse-core"></span>';
                el.addEventListener('mouseenter', () => {
                    tooltip.innerHTML = `<h3>${d.name}</h3><div class="stat"><span>Outgoing</span><span>${d.outgoing}</span></div><div class="stat"><span>Incoming</span><span>${d.incoming}</span></div>`;
                    tooltip.style.display = 'block';
                });
                el.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
                return el;
            });

        // --- CONTROLS & EVENTS ---
        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.5;
        
        // Tooltip follows mouse
        document.addEventListener('mousemove', (e) => {
            if (tooltip.style.display === 'block') {
                tooltip.style.left = `${e.clientX + 15}px`;
                tooltip.style.top = `${e.clientY - 15}px`;
            }
        });

        // Play/Pause UI logic
        elem.addEventListener('mouseenter', () => playPauseBtn.classList.add('visible'));
        elem.addEventListener('mouseleave', () => {
            if (!globeHovered) setTimeout(() => playPauseBtn.classList.remove('visible'), 500);
        });
        
        playPauseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            animationPlaying = !animationPlaying;
            playPauseBtn.querySelector('svg').innerHTML = animationPlaying 
                ? '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>' 
                : '<path d="M8 5v14l11-7z"/>';
            world.controls().autoRotate = animationPlaying;
        });

        window.addEventListener('resize', () => world.width(window.innerWidth).height(window.innerHeight));
        
        // Initial Zoom
        setTimeout(() => world.pointOfView({ lat: 20, lng: 20, altitude: 2.2 }, 1500), 500);
    </script>
</body>
</html>
